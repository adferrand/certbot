# Release pipeline to build and deploy Certbot for Windows for GitHub release tags
trigger:
  tags:
    include:
      - v0.*
pr: none

stages:
  - stage: build_n_test
    jobs:
      - template: templates/tests-suite.yml
      - template: templates/installer-tests.yml
  - stage: release
    jobs:
      - job: github
        pool:
          vmImage: vs2017-win2016
        steps:
          - task: DownloadPipelineArtifact@0
            inputs:
              artifactName: WindowsInstaller
              targetPath: $(Build.ArtifactStagingDirectory)
          - script: |
              $certbotVersion = $env:BUILD_SOURCEVERSION -replace "refs/tags/v"
              Write-Host "##vso[task.setvariable variable=CertbotVersion;]$certbotVersion"
            displayName: Configure GitHub release
          - task: GitHubRelease@0
            inputs:
              gitHubConnection: certbot-release
              action: create
              target: $(Build.SourceVersion)
              title: Certbot $(CertbotVersion)
              assets: $(Build.ArtifactStagingDirectory)/*.exe
              assetUploadMode: 'replace'
              addChangeLog: false
